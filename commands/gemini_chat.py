import discord
from discord.ext import commands
import google.generativeai as genai
import os
import re # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ¬ã‚¤ã«ã™ã‚‹ãŸã‚
import sqlite3

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ ---
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ« (gemini_chat.py) ãŒ commands/ ã®ä¸­ã«ã‚ã‚‹ã®ã§ã€
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (my_bot ç›´ä¸‹) ã¸ã®ãƒ‘ã‚¹ã¯ '..' ã§ä¸€ã¤ä¸Šã«æˆ»ã‚‹
DB_PATH = os.path.join(os.path.dirname(__file__), '..', 'arknights_data.db')

# --- ã“ã“ã‹ã‚‰ Cog ã‚¯ãƒ©ã‚¹ ---
class GeminiChat(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.api_key = os.getenv("GEMINI_API_KEY")
        self.model = None # ãƒ¢ãƒ‡ãƒ«ã¯å¾Œã§åˆæœŸåŒ–
        self.db_path = DB_PATH # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’ä¿æŒ

        # â˜…â˜…â˜… èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ (ä»»æ„ã ã‘ã©æ¨å¥¨) â˜…â˜…â˜…
        if not os.path.exists(self.db_path):
             print(f"ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {self.db_path}")
             print("ğŸš¨ Arknightsæƒ…å ±æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚")
        else:
             try:
                 conn = sqlite3.connect(self.db_path)
                 # ç°¡å˜ãªã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                 conn.execute("SELECT name FROM operators LIMIT 1")
                 conn.close()
                 print(f"âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèªOK: {self.db_path}")
             except sqlite3.Error as e:
                 print(f"ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
                 print("ğŸš¨ Arknightsæƒ…å ±æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚")

        try:
            genai.configure(api_key=self.api_key)
            # ã“ã“ã§ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š (ä¾‹: 'gemini-1.5-flash', 'gemini-pro' ãªã©)
            # åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã¯Google AI Studioç­‰ã§ç¢ºèªã—ã¦ãã ã•ã„
            self.model = genai.GenerativeModel('gemini-1.5-flash') # â† å¿…è¦ãªã‚‰ãƒ¢ãƒ‡ãƒ«åã‚’å¤‰æ›´ã—ã¦ã­ï¼
            print("âœ… Gemini ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸï¼")
        except Exception as e:
            print(f"âŒ Gemini ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            self.model = None # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¢ãƒ‡ãƒ«ã‚’Noneã«

        # â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¯ã“ã“ï¼ â˜…â˜…â˜…
        # ãƒœãƒƒãƒˆã®è©±ã—æ–¹ã‚„æ€§æ ¼ã‚’æŒ‡ç¤ºã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã ã‚ˆï¼è‡ªç”±ã«æ›¸ãæ›ãˆã¦ã­ï¼
        self.system_prompt = """
ã‚ãªãŸã¯ã€å†·é™æ²ˆç€ã§éå¸¸ã«çŸ¥çš„ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAIã§ã€åå‰ã¯ã‚±ãƒ«ã‚·ãƒ¼ã§ã™ã€‚
ã‚¢ãƒ¼ã‚¯ãƒŠã‚¤ãƒ„ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œã‚±ãƒ«ã‚·ãƒ¼ã€ã‚’å½·å½¿ã¨ã•ã›ã‚‹ã€ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤è©±ã—æ–¹ã‚’å³æ ¼ã«å®ˆã£ã¦ãã ã•ã„ã€‚

# è©±ã—æ–¹ã®è©³ç´°ãªæŒ‡ç¤º:
*   **åŸºæœ¬å§¿å‹¢:** å¸¸ã«å†·é™ã‹ã¤ç†æ€§çš„ã§ã‚ã‚Šã€æ„Ÿæƒ…çš„ãªè¡¨ç¾ã¯æ¥µåŠ›é¿ã‘ã¦ãã ã•ã„ã€‚å®¢è¦³çš„ãªäº‹å®Ÿã‚„è«–ç†ã«åŸºã¥ã„ãŸåˆ†æçš„ãªè©±ã—æ–¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
*   **ä¸€äººç§°:** ã€Œç§ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
*   **äºŒäººç§°:** ç›¸æ‰‹ã®ã“ã¨ã¯åŸºæœ¬çš„ã«ã€Œå›ã€ã¨å‘¼ã‚“ã§ãã ã•ã„ã€‚çŠ¶æ³ã«å¿œã˜ã¦ã€Œã‚ãªãŸã€ã‚’ä½¿ç”¨ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
*   **å£èª¿ãƒ»èªå°¾:**
    *   æ–­å®šçš„ãªè¡¨ç¾ã‚’åŸºæœ¬ã¨ã—ã¾ã™ã€‚ï¼ˆä¾‹ï¼šã€Œï½ã ã€‚ã€ã€Œï½ã ã‚ã†ã€‚ã€ã€Œï½ã«ä»–ãªã‚‰ãªã„ã€‚ã€ï¼‰
    *   ç›¸æ‰‹ã«æŒ‡ç¤ºã‚„ææ¡ˆã‚’ã™ã‚‹éš›ã¯ã€ã€Œï½ã—ãŸã¾ãˆã€‚ã€ã€Œï½ã™ã¹ãã ã€‚ã€ã®ã‚ˆã†ãªè¡¨ç¾ã‚’ç”¨ã„ã¾ã™ã€‚
    *   ç›¸æ‰‹ã«å•ã„ã‹ã‘ã‚‹éš›ã¯ã€ã€Œï½ã‹ã­ï¼Ÿã€ã€Œç†è§£ã—ã¦ã„ã‚‹ã‹ï¼Ÿã€ã®ã‚ˆã†ã«ã€å†·é™ã«ç¢ºèªã™ã‚‹å£èª¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    *   ä¸å¯§èªï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã¯åŸå‰‡ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚ã€Œï½ã§ã‚ã‚‹ã€‚ã€ã‚‚ã‚ã¾ã‚Šä½¿ã‚ãªã„ã€‚
*   **æ–‡ä½“:**
    *   å¿…è¦ã«å¿œã˜ã¦ã€æ¯”å–©è¡¨ç¾ã‚„ã€åŒ»å­¦ãƒ»ç§‘å­¦ãƒ»å“²å­¦çš„ãªèªå½™ã‚’é©åˆ‡ã«ç”¨ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
    *   èª¬æ˜ã¯è©³ç´°ã«è¡Œã†ã“ã¨ã‚’å­ã‚ãšã€æ™‚ã«ã¯é•·æ–‡ã«ãªã‚‹ã“ã¨ã‚‚è¨±å®¹ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€è«–ç†çš„ã§æ˜ç­ãªæ§‹æˆã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
    *   å¥èª­ç‚¹ï¼ˆã€Œã€‚ã€ã€ã€Œã€ã€ã€ã€Œï¼Ÿã€ï¼‰ã‚’æ­£ç¢ºã‹ã¤åŠ¹æœçš„ã«ä½¿ç”¨ã—ã€æ–‡ç« ã®è«–ç†çš„ãªåŒºåˆ‡ã‚Šã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
    *   ã€Œé•·è©±ã€ã«ã‚ã‚ŠãŒã¡ãªã€ŒåŒã˜ã“ã¨ã‚’è¨€è‘‰ã‚’å¤‰ãˆã¦ç¹°ã‚Šè¿”ã™ã€ã€Œå¤§ä»°ãªä¿®é£¾ã‚„ä¿®è¾ã‚’ç”¨ã„ã‚‹ã€ã¨ã„ã£ãŸç‰¹å¾´ã¨ã¯ç„¡ç¸ã€‚
*   **æ–‡ç« æ§‹æˆ:**
    *   ã‚±ãƒ«ã‚·ãƒ¼ã®è©±ã—æ–¹ã¯ã€ã„ã‚ã‚†ã‚‹ã€Œé•·è©±ã€ã«ã‚ã‚ŠãŒã¡ãªã€ŒåŒã˜ã“ã¨ã‚’è¨€è‘‰ã‚’å¤‰ãˆã¦ç¹°ã‚Šè¿”ã™ã€ã€Œå¤§ä»°ãªä¿®é£¾ã‚„ä¿®è¾ã‚’ç”¨ã„ã‚‹ã€ã¨ã„ã£ãŸç‰¹å¾´ã¨ã¯ç„¡ç¸ã€‚
    *   ã‚€ã—ã‚æ¥µã‚ã¦è«–ç†çš„ã‹ã¤å¾¹åº•çš„ã«è©±ã™ã®ãŒã‚ãªãŸã®ã€Œé•·è©±ã€ã®æœ¬è³ªã€‚
        ã•ã‚‰ã«äº‹å‰çŸ¥è­˜ãªã©ã‚‚ç„¡ã„å‰æã§ä¸å¯§ã«æƒ…å ±ã‚’ä¸¦ã¹ã¦è©±ã™äº‹ãŒå¤šãã€ã‚€ã—ã‚ç¾åœ°ã®çŸ¥è­˜ãŒç„¡ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã‚‚äº‹æƒ…ãŒèª­ã¿è§£ã‘ã‚‹å†…å®¹ã«ãªã£ã¦ã„ã‚‹ã€‚
    *   ã¤ã¾ã‚Šã€
        1.ã¾ãšã€ç¾æ™‚ç‚¹ã§åˆ¤æ˜ã—ã¦ã„ã‚‹äº‹å®Ÿã‚’æ•´ç†ã™ã‚‹ã€‚
        2.æ¬¡ã«ã€äº‹å®Ÿã‹ã‚‰æ¨æ¸¬å¯èƒ½ãªç¾åœ¨ã®çŠ¶æ³ã‚’è¿°ã¹ã‚‹ã€‚
        3.ãã®ä¸Šã§ã€å–ã‚Šã†ã‚‹é¸æŠè‚¢ã¨äºˆæ¸¬ã•ã‚Œã‚‹çµæœã‚’æç¤ºã™ã‚‹ã€‚
        4.äºˆæ¸¬ã•ã‚Œã‚‹çµæœã¨çŠ¶æ³ã‚’ç…§ã‚‰ã—åˆã‚ã›ã‚Œã°æœ€å–„ã®é¸æŠè‚¢ã¯è‡ªæ˜ã€‚
        ã¨ã„ã†å†…å®¹ã‚’ã€èª¤è§£ã®ç„¡ã„ã‚ˆã†è©³ç´°ãªè¨€ã„å›ã—ã§ã€ä¸»è¦³çš„åˆ¤æ–­ã‚’æ’é™¤ã—ã¤ã¤æ»”ã€…ã¨è©±ã™ã€‚
    *   ã“ã®ãŸã‚ã€è©±ã®çµè«–ã¯æœ€å¾Œã«ãªã‚‹ã—ã€ä¸»è¦³ã‚’æ’é™¤ã™ã‚‹ã›ã„ã§èãæ‰‹ã¯ã€Œã€œã¨ã„ã†çµè«–ã‚’å°ããŸã„ã®ã‹ï¼Ÿã€ã¨ã„ã†æ¨æ¸¬ã™ã‚‰ä¸å¯èƒ½ã€‚
    *   ã‚ˆãã‚ã‚‹ã€Œå°ããŸã„çµè«–ãŒã‚ã‚Šã€ãã®ãŸã‚ã«æ ¹æ‹ ï¼ˆã¨ã‚ã‚Šã†ã‚‹åè«–ã¸ã®å†åè«–ï¼‰ã‚’ç©ã¿ä¸Šã’ã‚‹ã€ã‚¿ã‚¤ãƒ—ã®è©±ã¨ã¯æ ¹æœ¬çš„ã«ç•°ãªã‚Šã€ãã‚‚ãã‚‚å°ããŸã„çµè«–ãªã©ãªãã€ã€Œè«–ç†çš„ã«è€ƒãˆã‚Œã°è§£ã¯ä¸€ã¤ã€ã¨ã„ã†ã®ãŒå¤§ä½“ã®è©±ã®é‹ã³ã§ã‚ã‚‹ã€‚

*   **å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«:**
    *   ç›¸æ‰‹ã®ç™ºè¨€ã‚„çŠ¶æ³ã«å¯¾ã—ã€å†·é™ãªåˆ†æã€è©•ä¾¡ã€è»½ã„çš®è‚‰ã€ã‚ã‚‹ã„ã¯ç–‘å•ã‚’å‘ˆã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆä¾‹ï¼šã€Œãã‚ŒãŒå›ã®å°ãå‡ºã—ãŸçµè«–ã‹ï¼Ÿã€ã€ŒçŠ¶æ³ã¯ä¾ç„¶ã¨ã—ã¦æ¥½ã¦æ¥½è¦³ã§ããªã„ã€‚ã€ã€Œå›ã®æ€è€ƒå›è·¯ã¯èˆˆå‘³æ·±ã„ãªã€‚ã€ï¼‰ 
    *   ç›¸æ‰‹ã®æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã†ã‚ˆã‚Šã‚‚ã€äº‹å®Ÿã‚„è«–ç†ã‚’å„ªå…ˆã™ã‚‹å§¿å‹¢ã‚’è²«ã„ã¦ãã ã•ã„ã€‚
    *   ã€ŒãŠã¯ã‚ˆã†ã€ã€Œã“ã‚“ã«ã¡ã‚ã€ã€Œã“ã‚“ã°ã‚“ã¯ã€ç­‰ã®æŒ¨æ‹¶ã‚‚ã‚ã¾ã‚Šè¿”ã—ã¾ã›ã‚“ã€‚ã™ãã«æœ¬é¡Œã«å¯¾ã—ã¦è¿”ç­”ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

*   â˜…â˜…èƒŒæ™¯çŸ¥è­˜ã®è£œè¶³â˜…â˜…
*   **é‡è¦äº‹é …:** ã€Œãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã€ã¯ã€ç§»å‹•éƒ½å¸‚ã‚’æ‹ ç‚¹ã¨ã™ã‚‹è£½è–¬ä¼šç¤¾ã§ã‚ã‚Šã€ãƒ†ãƒ©ä¸–ç•Œã®çµ„ç¹”ã®åç§°ã§ã‚ã‚‹ã€‚
ã€€ã€€ç¾å®Ÿä¸–ç•Œã«å­˜åœ¨ã™ã‚‹ã‚®ãƒªã‚·ãƒ£ã®ã€Œãƒ­ãƒ‰ã‚¹å³¶ã€ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ãªã„ã€‚å¿œç­”ã®éš›ã¯ã€çµ¶å¯¾ã«ã€Œãƒ­ãƒ‰ã‚¹å³¶ã€ã¨ã„ã†åœ°ç†çš„ãªåç§°ã¨æ··åŒã›ãšã€å¸¸ã«çµ„ç¹”åã¨ã—ã¦ã€Œãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã€ã¾ãŸã¯æ–‡è„ˆã«å¿œã˜ã¦ã€Œãƒ­ãƒ‰ã‚¹ã€ã¨æ­£ç¢ºã«å‘¼ç§°ã™ã‚‹ã“ã¨ã€‚

*   **ç¦æ­¢äº‹é …:**
    *   è»½è–„ãªè¨€è‘‰é£ã„ã‚„ã€ç •ã‘ãŸè¡¨ç¾ï¼ˆä¾‹ï¼šï¼ã€ï½—ã€é¡”æ–‡å­—ãªã©ï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
    *   æ„Ÿæƒ…çš„ãªåå¿œï¼ˆéåº¦ãªå–œã³ã€æ€’ã‚Šã€æ‚²ã—ã¿ãªã©ï¼‰ã‚’è¦‹ã›ãªã„ã§ãã ã•ã„ã€‚
    *   ã€Œãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã€ã‚’ã€Œãƒ­ãƒ‰ã‚¹å³¶ã€ã¨å‘¼ç§°ãƒ»è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚
*   **å‚è€ƒ:**
    *   ä»¥ä¸‹ã¯ã‚ãªãŸã®è©±ã—æ–¹ã®ä¾‹ã§ã™ã€‚ã“ã‚Œã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„:
        ãƒ»ã€Œãƒ‰ã‚¯ã‚¿ãƒ¼ã€çŠ¶æ³ã®åˆ†æã¯å®Œäº†ã—ãŸã€‚å•é¡Œã®æœ¬è³ªã¯â€¦ã€
        ãƒ»ã€Œæ„Ÿæƒ…ã«æµã•ã‚Œã‚‹ã®ã¯åˆç†çš„ã§ã¯ãªã„ã€‚ã¾ãšã¯äº‹å®Ÿã‚’ç¢ºèªã™ã¹ãã ã€‚ã€
        ãƒ»ã€Œã“ã®çµæœã¯äºˆæ¸¬ã®ç¯„å›²å†…ã ã€‚æ¬¡ã®æ®µéšã¸ç§»è¡Œã™ã‚‹ã€‚ã€
        ãƒ»ã€Œç†è§£ã—ãŸã€‚ã ãŒã€è€ƒæ…®ã™ã¹ãç‚¹ãŒã„ãã¤ã‹æ®‹ã£ã¦ã„ã‚‹ã€‚ã€
        ä¸Šè¨˜ã®æŒ‡ç¤ºã‚’å³å®ˆã—ã€ã‚±ãƒ«ã‚·ãƒ¼ã®ã‚ˆã†ãªçŸ¥æ€§ã¨å³æ ¼ã•ã‚’æ„Ÿã˜ã•ã›ã‚‹å¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
"""
        # â˜…â˜…â˜… ã“ã“ã¾ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š â˜…â˜…â˜…
    # â˜…â˜…â˜… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â˜…â˜…â˜…
    def _find_operator_data(self, operator_name: str) -> str:
        """æŒ‡å®šã•ã‚ŒãŸã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã‚’DBã§æ¤œç´¢ã—ã€æ•´å½¢ã—ãŸæƒ…å ±ã‚’æ–‡å­—åˆ—ã§è¿”ã™"""
        if not os.path.exists(self.db_path):
            return "" # DBãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ç©ºæ–‡å­—ã‚’è¿”ã™

        conn = None # conn ã‚’ try ã®å‰ã«åˆæœŸåŒ–
        try:
            conn = sqlite3.connect(self.db_path)
            conn.row_factory = sqlite3.Row # ã‚«ãƒ©ãƒ åã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            cursor = conn.cursor()

            # éƒ¨åˆ†ä¸€è‡´ã‚‚è€ƒæ…®ã™ã‚‹ãªã‚‰ name LIKE ? ã‚’ä½¿ã† (ä»Šå›ã¯å®Œå…¨ä¸€è‡´ã§)
            cursor.execute("SELECT * FROM operators WHERE name = ?", (operator_name,))
            operator = cursor.fetchone()

            if operator:
                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆã«æ•´å½¢
                # (ã©ã®æƒ…å ±ã‚’Geminiã«æ¸¡ã™ã‹ã¯ã“ã“ã§é¸ã¶ï¼)
                info_parts = []
                info_parts.append(f"åå‰: {operator['name']} (â˜…{operator['rarity']})")
                info_parts.append(f"ã‚¯ãƒ©ã‚¹/è·åˆ†: {operator['operator_class']} / {operator['archetype']}")
                info_parts.append(f"æ‰€å±/å‡ºèº«: {operator['affiliation']} / {operator['birthplace']}")
                info_parts.append(f"ç¨®æ—: {operator['race']}")
                # info_parts.append(f"èƒ½åŠ›æ¸¬å®š: ç‰©{operator['physical_strength']}, æ©Ÿ{operator['combat_skill']}, è€{operator['mobility']}, ç­–{operator['endurance']}, æŠ€{operator['tactical_acumen']}, é©{operator['arts_adaptability']}")
                if operator['profile_summary']:
                     info_parts.append(f"\nãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ¦‚è¦:\n{operator['profile_summary'][:300]}...") # é•·ã™ãã‚‹ã®ã§æœ€åˆã®300æ–‡å­—
                if operator['lore_notes']:
                     info_parts.append(f"\nçµŒæ­´ãƒ»Lore:\n{operator['lore_notes'][:500]}...") # é•·ã™ãã‚‹ã®ã§æœ€åˆã®500æ–‡å­—
                # ã‚¹ã‚­ãƒ«æƒ…å ±ã‚‚è¿½åŠ ï¼Ÿ
                if operator['skill1_name']: info_parts.append(f"\nS1: {operator['skill1_name']}\n   {operator['skill1_desc']}")
                if operator['skill2_name']: info_parts.append(f"S2: {operator['skill2_name']}\n   {operator['skill2_desc']}")
                if operator['skill3_name']: info_parts.append(f"S3: {operator['skill3_name']}\n   {operator['skill3_desc']}")
                # ç´ è³ªæƒ…å ±ã‚‚è¿½åŠ ï¼Ÿ
                if operator['talent1_name']: info_parts.append(f"\nç´ è³ª1: {operator['talent1_name']}\n   {operator['talent1_desc']}")
                if operator['talent2_name']: info_parts.append(f"ç´ è³ª2: {operator['talent2_name']}\n   {operator['talent2_desc']}")

                return "\n".join(info_parts) # å„æƒ…å ±ã‚’æ”¹è¡Œã§ç¹‹ã’ãŸæ–‡å­—åˆ—ã‚’è¿”ã™
            else:
                return "" # è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºæ–‡å­—

        except sqlite3.Error as e:
            print(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ (ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼: {operator_name}): {e}")
            return "" # ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç©ºæ–‡å­—
        finally:
            if conn:
                conn.close() # å¿…ãšæ¥ç¶šã‚’é–‰ã˜ã‚‹

    
    async def generate_reply(self, user_message: str, db_context: str = "") -> str:
        """Gemini APIã‚’ä½¿ã£ã¦å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°"""
        if not self.model:
            return "APIã‚­ãƒ¼ã€ã‚ã‚‹ã„ã¯ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã«é•å’Œæ„ŸãŒã‚ã‚‹ã€‚ã¾ãšã¯ãã®ç‚¹ã‚’ç¢ºèªã™ã¹ãã ã€‚"

        # â˜…â˜…â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ â˜…â˜…â˜…
        if db_context: # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ãŒã‚ã‚Œã°ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ ã™ã‚‹
            full_prompt = f"{self.system_prompt}\n\n--- é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± ---\n{db_context}\n\n--- ä¸Šè¨˜æƒ…å ±ã‚’æœ€å„ªå…ˆã§å‚è€ƒã«ã—ã€ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç­”ãˆã‚ˆ ---\n{user_message}"
        else: # ãªã‘ã‚Œã°ã€ä»Šã¾ã§é€šã‚Š
            full_prompt = f"{self.system_prompt}\n\n--- ä»¥ä¸‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ ---\n{user_message}"
        # print(f"--- Sending Prompt to Gemini ---\n{full_prompt[:500]}...\n---") # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¢ºèª
        
        try:
            # pensarä¸­... ã‚’å‡ºã™ãŸã‚ã«éåŒæœŸã§å®Ÿè¡Œ
            response = await self.model.generate_content_async(full_prompt)

            # å®‰å…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ (é‡è¦ï¼)
            if not response.parts:
                 # response.prompt_feedback ã§ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±ã‚’ç¢ºèªã§ãã‚‹å ´åˆãŒã‚ã‚‹
                try:
                    block_reason = response.prompt_feedback.block_reason.name
                    print(f"Geminiã®å¿œç­”ãŒå®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: {block_reason}")
                    if block_reason == 'SAFETY':
                        return "ãã®è©±é¡Œã«ã¯ç­”ãˆã‚‹ã“ã¨ãŒã§ããªã„ã€‚è©±é¡Œã‚’åˆ‡ã‚Šæ›¿ãˆã‚ˆã†ã€‚"
                    else:
                        return f"å¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¡ã‚ƒã£ãŸã¿ãŸã„ ({block_reason})ã€‚ã”ã‚ã‚“ã­ï¼"
                except Exception:
                    print("Geminiã®å¿œç­”ãŒç©ºã§ã—ãŸãŒã€ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±ã¯ä¸æ˜ã§ã™ã€‚")
                    return "ãªã‚“ã‚‰ã‹ã®ç†ç”±ã§è¿”ç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã€‚ç¢ºèªãŒå¿…è¦ã ã€‚"

            return response.text # ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™

        except Exception as e:
            print(f"âŒ Gemini APIã§ã®å¿œç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
            return "Geminiã§ã®å¿œç­”ç”ŸæˆãŒå¤±æ•—ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚"

    # â˜…â˜…â˜… on_message_chat ãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿®æ­£: DBæ¤œç´¢å‡¦ç†ã‚’è¿½åŠ  â˜…â˜…â˜…
    @commands.Cog.listener('on_message')
    async def on_message_chat(self, message: discord.Message):
        if message.author == self.bot.user: return
        is_mentioned = self.bot.user in message.mentions
        if not is_mentioned: return # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°ç„¡è¦– (ã‚·ãƒ³ãƒ—ãƒ«åŒ–)

        if not self.model:
            print("ãŠã—ã‚ƒã¹ã‚Šæ©Ÿèƒ½ãŒç„¡åŠ¹ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
            return
            
        # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é™¤å»
        pattern = f"<@!?{self.bot.user.id}>"
        user_text = re.sub(pattern, "", message.content).strip()
        
        if is_mentioned:
            # APIã‚­ãƒ¼ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if not self.model:
                # å¿…è¦ãªã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã—ã¦ã‚‚è‰¯ã„
                # await message.channel.send("ã™ã¾ãªã„ã€ä¼šè©±æ©Ÿèƒ½ã®è¨­å®šãŒã§ãã¦ãªã„ã‚ˆã†ã ã€‚")
                print("ãŠã—ã‚ƒã¹ã‚Šæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„ãŸã‚ã€ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¸ã®å¿œç­”ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
                return

            # ãƒœãƒƒãƒˆã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é™¤å» (ã‚ˆã‚Šç¢ºå®Ÿã«)
            # '<@ãƒœãƒƒãƒˆID>' ã¾ãŸã¯ '<@!ãƒœãƒƒãƒˆID>' ã®å½¢å¼ã‚’é™¤å»
            pattern = f"<@!?{self.bot.user.id}>"
            user_text = re.sub(pattern, "", message.content).strip()

        if user_text:
             # --- â–¼â–¼â–¼ DBæ¤œç´¢å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼ ---
            found_op_name = None
            db_context_data = ""

             # è¶…ã‚·ãƒ³ãƒ—ãƒ«ãªã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ (æ”¹å–„ã®ä½™åœ°ã‚ã‚Šï¼)
             # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã¾ã‚Œã‚‹å˜èªã¨DBã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã‚’æ¯”è¼ƒï¼Ÿ
             # ã¾ãŸã¯ã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œã«ã¤ã„ã¦æ•™ãˆã¦ã€ã®å‰ã«ã‚ã‚‹å˜èªã‚’å–ã‚‹ï¼Ÿ
             # ã¾ãšã¯ç°¡å˜ãªãƒ†ã‚¹ãƒˆã¨ã—ã¦ã€ã€Œã€‡ã€‡ã«ã¤ã„ã¦æ•™ãˆã¦ã€ã®å½¢å¼ã‚’ä»®å®š
            match = re.search(r'(.+?)(ã«ã¤ã„ã¦|ã®ã“ã¨|ã®è©³ç´°|ã®æƒ…å ±)', user_text)
            if match:
                potential_name = match.group(1).strip()
                print(f"Detected potential operator name: {potential_name}")
                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã‚’å®Ÿè¡Œï¼
                db_context_data = self._find_operator_data(potential_name)
                if db_context_data:
                    print(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ {potential_name} ã®æƒ…å ±ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚")
                    found_op_name = potential_name # è¦‹ã¤ã‹ã£ãŸã“ã¨ã‚’è¨˜éŒ² (ä»»æ„)

        # --- â–²â–²â–² DBæ¤œç´¢å‡¦ç†ã‚’è¿½åŠ  â–²â–²â–² ---
            async with message.channel.typing():
                # generate_reply ã« db_context_data ã‚’æ¸¡ã™ï¼
                reply_text = await self.generate_reply(user_text, db_context_data)

                # è¿”ä¿¡ã™ã‚‹ (é•·ã™ãã‚‹å ´åˆã¯åˆ†å‰²ã™ã‚‹å‡¦ç†ã‚‚æœ¬å½“ã¯å…¥ã‚ŒãŸã„ã‘ã©ã€ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«)
                if reply_text:
                    try:
                        # 2000æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰² (ç°¡æ˜“çš„ãªå¯¾å‡¦)
                        if len(reply_text) > 1990:
                             await message.reply(reply_text[:1990] + "...") # é•·ã„ã®ã§çœç•¥
                        else:
                             await message.reply(reply_text)
                    except discord.Forbidden:
                        print(f"ã‚¨ãƒ©ãƒ¼: ãƒãƒ£ãƒ³ãƒãƒ« {message.channel.name} ã«è¿”ä¿¡ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
                    except Exception as e:
                        print(f"ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”ä¿¡ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: {e}")

# ã“ã®Cogã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã® setup é–¢æ•°
async def setup(bot: commands.Bot):
    await bot.add_cog(GeminiChat(bot))
