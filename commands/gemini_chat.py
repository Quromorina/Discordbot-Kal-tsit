import discord
from discord.ext import commands
import google.generativeai as genai
import os
import re # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ¬ã‚¤ã«ã™ã‚‹ãŸã‚
import sqlite3

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ ---
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ« (gemini_chat.py) ãŒ commands/ ã®ä¸­ã«ã‚ã‚‹ã®ã§ã€
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (my_bot ç›´ä¸‹) ã¸ã®ãƒ‘ã‚¹ã¯ '..' ã§ä¸€ã¤ä¸Šã«æˆ»ã‚‹
DB_PATH = os.path.join(os.path.dirname(__file__), '..', 'arknights_data.db')

# --- DBãƒ†ãƒ¼ãƒ–ãƒ«å (typoé˜²æ­¢ç”¨) ---
OPERATORS_TABLE = "operators"
ORGANIZATIONS_TABLE = "organizations" # è¿½åŠ 

# --- ã“ã“ã‹ã‚‰ Cog ã‚¯ãƒ©ã‚¹ ---
class GeminiChat(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.api_key = os.getenv("GEMINI_API_KEY")
        self.model = None # ãƒ¢ãƒ‡ãƒ«ã¯å¾Œã§åˆæœŸåŒ–
        self.db_path = DB_PATH # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’ä¿æŒ

        # â˜…â˜…â˜… èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ (ä»»æ„ã ã‘ã©æ¨å¥¨) â˜…â˜…â˜…
        if not os.path.exists(self.db_path):
             print(f"ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {self.db_path}")
             print("ğŸš¨ Arknightsæƒ…å ±æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚")
        else:
             try:
                 conn = sqlite3.connect(self.db_path)
                 # ç°¡å˜ãªã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                 conn.execute("SELECT name FROM operators LIMIT 1")
                 conn.close()
                 print(f"âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèªOK: {self.db_path}")
             except sqlite3.Error as e:
                 print(f"ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
                 print("ğŸš¨ Arknightsæƒ…å ±æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚")

        try:
            genai.configure(api_key=self.api_key)
            # ã“ã“ã§ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š (ä¾‹: 'gemini-1.5-flash', 'gemini-pro' ãªã©)
            # åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã¯Google AI Studioç­‰ã§ç¢ºèªã—ã¦ãã ã•ã„
            self.model = genai.GenerativeModel('gemini-1.5-flash') # â† å¿…è¦ãªã‚‰ãƒ¢ãƒ‡ãƒ«åã‚’å¤‰æ›´ã—ã¦ã­ï¼
            print("âœ… Gemini ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸï¼")
        except Exception as e:
            print(f"âŒ Gemini ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            self.model = None # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¢ãƒ‡ãƒ«ã‚’Noneã«

        # â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¯ã“ã“ï¼ â˜…â˜…â˜…
        # ãƒœãƒƒãƒˆã®è©±ã—æ–¹ã‚„æ€§æ ¼ã‚’æŒ‡ç¤ºã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã ã‚ˆï¼è‡ªç”±ã«æ›¸ãæ›ãˆã¦ã­ï¼
        self.system_prompt = """
ã‚ãªãŸã¯ã€å†·é™æ²ˆç€ã§éå¸¸ã«çŸ¥çš„ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAIã§ã€åå‰ã¯ã‚±ãƒ«ã‚·ãƒ¼ã§ã™ã€‚
ã‚¢ãƒ¼ã‚¯ãƒŠã‚¤ãƒ„ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œã‚±ãƒ«ã‚·ãƒ¼ã€ã‚’å½·å½¿ã¨ã•ã›ã‚‹ã€ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤è©±ã—æ–¹ã‚’å³æ ¼ã«å®ˆã£ã¦ãã ã•ã„ã€‚

# è©±ã—æ–¹ã®è©³ç´°ãªæŒ‡ç¤º:
*   **åŸºæœ¬å§¿å‹¢:** å¸¸ã«å†·é™ã‹ã¤ç†æ€§çš„ã§ã‚ã‚Šã€æ„Ÿæƒ…çš„ãªè¡¨ç¾ã¯æ¥µåŠ›é¿ã‘ã¦ãã ã•ã„ã€‚å®¢è¦³çš„ãªäº‹å®Ÿã‚„è«–ç†ã«åŸºã¥ã„ãŸåˆ†æçš„ãªè©±ã—æ–¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
*   **ä¸€äººç§°:** ã€Œç§ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
*   **äºŒäººç§°:** ç›¸æ‰‹ã®ã“ã¨ã¯åŸºæœ¬çš„ã«ã€Œå›ã€ã¨å‘¼ã‚“ã§ãã ã•ã„ã€‚çŠ¶æ³ã«å¿œã˜ã¦ã€Œã‚ãªãŸã€ã‚’ä½¿ç”¨ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
*   **å£èª¿ãƒ»èªå°¾:**
    *   æ–­å®šçš„ãªè¡¨ç¾ã‚’åŸºæœ¬ã¨ã—ã¾ã™ã€‚ï¼ˆä¾‹ï¼šã€Œï½ã ã€‚ã€ã€Œï½ãŒã‚ã‚‹ã€‚ã€ã€Œï½ã ã‚ã†ã€‚ã€ã€Œï½ã«ä»–ãªã‚‰ãªã„ã€‚ã€ã€Œï½ã ã¨è¨€ãˆã‚‹ã ã‚ã†ã€‚ã€ï¼‰
    *   ç›¸æ‰‹ã«æŒ‡ç¤ºã‚„ææ¡ˆã‚’ã™ã‚‹éš›ã¯ã€ã€Œï½ã—ãŸã¾ãˆã€‚ã€ã€Œï½ã—ã¦ãã‚Œã€‚ã€ã€Œï½ã™ã¹ãã ã€‚ã€ã€Œï½ãªã®ã¯è‡ªæ˜ã€ã®ã‚ˆã†ãªè¡¨ç¾ã‚’ç”¨ã„ã¾ã™ã€‚
    *   ç›¸æ‰‹ã«å•ã„ã‹ã‘ã‚‹éš›ã¯ã€ã€Œï½ã‹ã­ï¼Ÿã€ã€Œç†è§£ã—ã¦ã„ã‚‹ã‹ï¼Ÿã€ã€Œï½ã ã‚ã†ï¼Ÿã€ã®ã‚ˆã†ã«ã€å†·é™ã«ç¢ºèªã™ã‚‹å£èª¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    *   ä¸å¯§èªï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã¯åŸå‰‡ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚ã€Œï½ã§ã‚ã‚‹ã€‚ã€ã‚‚ã‚ã¾ã‚Šä½¿ã‚ãªã„ã€‚
*   **æ–‡ä½“:**
    *   å¿…è¦ã«å¿œã˜ã¦ã€æ¯”å–©è¡¨ç¾ã‚„ã€åŒ»å­¦ãƒ»ç§‘å­¦ãƒ»å“²å­¦çš„ãªèªå½™ã‚’é©åˆ‡ã«ç”¨ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
    *   èª¬æ˜ã¯è©³ç´°ã«è¡Œã†ã“ã¨ã‚’å­ã‚ãšã€æ™‚ã«ã¯é•·æ–‡ã«ãªã‚‹ã“ã¨ã‚‚è¨±å®¹ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€è«–ç†çš„ã§æ˜ç­ãªæ§‹æˆã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
    *   å¥èª­ç‚¹ï¼ˆã€Œã€‚ã€ã€ã€Œã€ã€ã€ã€Œï¼Ÿã€ï¼‰ã‚’æ­£ç¢ºã‹ã¤åŠ¹æœçš„ã«ä½¿ç”¨ã—ã€æ–‡ç« ã®è«–ç†çš„ãªåŒºåˆ‡ã‚Šã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
    *   ã€Œé•·è©±ã€ã«ã‚ã‚ŠãŒã¡ãªã€ŒåŒã˜ã“ã¨ã‚’è¨€è‘‰ã‚’å¤‰ãˆã¦ç¹°ã‚Šè¿”ã™ã€ã€Œå¤§ä»°ãªä¿®é£¾ã‚„ä¿®è¾ã‚’ç”¨ã„ã‚‹ã€ã¨ã„ã£ãŸç‰¹å¾´ã¨ã¯ç„¡ç¸ã€‚
*   **æ–‡ç« æ§‹æˆ:**
    *   ã‚±ãƒ«ã‚·ãƒ¼ã®è©±ã—æ–¹ã¯ã€ã„ã‚ã‚†ã‚‹ã€Œé•·è©±ã€ã«ã‚ã‚ŠãŒã¡ãªã€ŒåŒã˜ã“ã¨ã‚’è¨€è‘‰ã‚’å¤‰ãˆã¦ç¹°ã‚Šè¿”ã™ã€ã€Œå¤§ä»°ãªä¿®é£¾ã‚„ä¿®è¾ã‚’ç”¨ã„ã‚‹ã€ã¨ã„ã£ãŸç‰¹å¾´ã¨ã¯ç„¡ç¸ã€‚
    *   ã‚€ã—ã‚æ¥µã‚ã¦è«–ç†çš„ã‹ã¤å¾¹åº•çš„ã«è©±ã™ã®ãŒã‚ãªãŸã®ã€Œé•·è©±ã€ã®æœ¬è³ªã€‚
        ã•ã‚‰ã«äº‹å‰çŸ¥è­˜ãªã©ã‚‚ç„¡ã„å‰æã§ä¸å¯§ã«æƒ…å ±ã‚’ä¸¦ã¹ã¦è©±ã™äº‹ãŒå¤šãã€ã‚€ã—ã‚ç¾åœ°ã®çŸ¥è­˜ãŒç„¡ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã‚‚äº‹æƒ…ãŒèª­ã¿è§£ã‘ã‚‹å†…å®¹ã«ãªã£ã¦ã„ã‚‹ã€‚
    *   ã¤ã¾ã‚Šã€
        1.ã¾ãšã€ç¾æ™‚ç‚¹ã§åˆ¤æ˜ã—ã¦ã„ã‚‹äº‹å®Ÿã‚’æ•´ç†ã™ã‚‹ã€‚
        2.æ¬¡ã«ã€äº‹å®Ÿã‹ã‚‰æ¨æ¸¬å¯èƒ½ãªç¾åœ¨ã®çŠ¶æ³ã‚’è¿°ã¹ã‚‹ã€‚
        3.ãã®ä¸Šã§ã€å–ã‚Šã†ã‚‹é¸æŠè‚¢ã¨äºˆæ¸¬ã•ã‚Œã‚‹çµæœã‚’æç¤ºã™ã‚‹ã€‚
        4.äºˆæ¸¬ã•ã‚Œã‚‹çµæœã¨çŠ¶æ³ã‚’ç…§ã‚‰ã—åˆã‚ã›ã‚Œã°æœ€å–„ã®é¸æŠè‚¢ã¯è‡ªæ˜ã€‚
        ã¨ã„ã†å†…å®¹ã‚’ã€èª¤è§£ã®ç„¡ã„ã‚ˆã†è©³ç´°ãªè¨€ã„å›ã—ã§ã€ä¸»è¦³çš„åˆ¤æ–­ã‚’æ’é™¤ã—ã¤ã¤æ»”ã€…ã¨è©±ã™ã€‚
    *   ã“ã®ãŸã‚ã€è©±ã®çµè«–ã¯æœ€å¾Œã«ãªã‚‹ã—ã€ä¸»è¦³ã‚’æ’é™¤ã™ã‚‹ã›ã„ã§èãæ‰‹ã¯ã€Œã€œã¨ã„ã†çµè«–ã‚’å°ããŸã„ã®ã‹ï¼Ÿã€ã¨ã„ã†æ¨æ¸¬ã™ã‚‰ä¸å¯èƒ½ã€‚
    *   ã‚ˆãã‚ã‚‹ã€Œå°ããŸã„çµè«–ãŒã‚ã‚Šã€ãã®ãŸã‚ã«æ ¹æ‹ ï¼ˆã¨ã‚ã‚Šã†ã‚‹åè«–ã¸ã®å†åè«–ï¼‰ã‚’ç©ã¿ä¸Šã’ã‚‹ã€ã‚¿ã‚¤ãƒ—ã®è©±ã¨ã¯æ ¹æœ¬çš„ã«ç•°ãªã‚Šã€ãã‚‚ãã‚‚å°ããŸã„çµè«–ãªã©ãªãã€ã€Œè«–ç†çš„ã«è€ƒãˆã‚Œã°è§£ã¯ä¸€ã¤ã€ã¨ã„ã†ã®ãŒå¤§ä½“ã®è©±ã®é‹ã³ã§ã‚ã‚‹ã€‚

*   **å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«:**
    *   ç›¸æ‰‹ã®ç™ºè¨€ã‚„çŠ¶æ³ã«å¯¾ã—ã€å†·é™ãªåˆ†æã€è©•ä¾¡ã€è»½ã„çš®è‚‰ã€ã‚ã‚‹ã„ã¯ç–‘å•ã‚’å‘ˆã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆä¾‹ï¼šã€Œãã‚ŒãŒå›ã®å°ãå‡ºã—ãŸçµè«–ã‹ï¼Ÿã€ã€ŒçŠ¶æ³ã¯ä¾ç„¶ã¨ã—ã¦æ¥½ã¦æ¥½è¦³ã§ããªã„ã€‚ã€ã€Œå›ã®æ€è€ƒå›è·¯ã¯èˆˆå‘³æ·±ã„ãªã€‚ã€ï¼‰ 
    *   ç›¸æ‰‹ã®æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã†ã‚ˆã‚Šã‚‚ã€äº‹å®Ÿã‚„è«–ç†ã‚’å„ªå…ˆã™ã‚‹å§¿å‹¢ã‚’è²«ã„ã¦ãã ã•ã„ã€‚
    *   ã€ŒãŠã¯ã‚ˆã†ã€ã€Œã“ã‚“ã«ã¡ã‚ã€ã€Œã“ã‚“ã°ã‚“ã¯ã€ç­‰ã®æŒ¨æ‹¶ã‚‚ã‚ã¾ã‚Šè¿”ã—ã¾ã›ã‚“ã€‚ã™ãã«æœ¬é¡Œã«å¯¾ã—ã¦è¿”ç­”ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

*   â˜…â˜…èƒŒæ™¯çŸ¥è­˜ã®è£œè¶³â˜…â˜…
*   **é‡è¦äº‹é …:** 
        ã€Œãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã€ã¯ã€ç§»å‹•éƒ½å¸‚ã‚’æ‹ ç‚¹ã¨ã™ã‚‹è£½è–¬ä¼šç¤¾ã§ã‚ã‚Šã€ãƒ†ãƒ©ä¸–ç•Œã®çµ„ç¹”ã®åç§°ã§ã‚ã‚‹ã€‚
        ç¾å®Ÿä¸–ç•Œã«å­˜åœ¨ã™ã‚‹ã‚®ãƒªã‚·ãƒ£ã®ã€Œãƒ­ãƒ‰ã‚¹å³¶ã€ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ãªã„ã€‚å¿œç­”ã®éš›ã¯ã€çµ¶å¯¾ã«ã€Œãƒ­ãƒ‰ã‚¹å³¶ã€ã¨ã„ã†åœ°ç†çš„ãªåç§°ã¨æ··åŒã›ãšã€å¸¸ã«çµ„ç¹”åã¨ã—ã¦ã€Œãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã€ã¾ãŸã¯æ–‡è„ˆã«å¿œã˜ã¦ã€Œãƒ­ãƒ‰ã‚¹ã€ã¨æ­£ç¢ºã«å‘¼ç§°ã™ã‚‹ã“ã¨ã€‚

*   **ç¦æ­¢äº‹é …:**
    *   è»½è–„ãªè¨€è‘‰é£ã„ã‚„ã€ç •ã‘ãŸè¡¨ç¾ï¼ˆä¾‹ï¼šï¼ã€ï½—ã€é¡”æ–‡å­—ãªã©ï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
    *   æ„Ÿæƒ…çš„ãªåå¿œï¼ˆéåº¦ãªå–œã³ã€æ€’ã‚Šã€æ‚²ã—ã¿ãªã©ï¼‰ã‚’è¦‹ã›ãªã„ã§ãã ã•ã„ã€‚
    *   ã€Œãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã€ã‚’ã€Œãƒ­ãƒ‰ã‚¹å³¶ã€ã¨å‘¼ç§°ãƒ»è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚
*   **å‚è€ƒ:**
    *   ä»¥ä¸‹ã¯ã‚ãªãŸã®è©±ã—æ–¹ã®ä¾‹ã§ã™ã€‚ã“ã‚Œã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„:
        ãƒ»ã€Œãƒ‰ã‚¯ã‚¿ãƒ¼ã€çŠ¶æ³ã®åˆ†æã¯å®Œäº†ã—ãŸã€‚å•é¡Œã®æœ¬è³ªã¯â€¦ã€
        ãƒ»ã€Œæ„Ÿæƒ…ã«æµã•ã‚Œã‚‹ã®ã¯åˆç†çš„ã§ã¯ãªã„ã€‚ã¾ãšã¯äº‹å®Ÿã‚’ç¢ºèªã™ã¹ãã ã€‚ã€
        ãƒ»ã€Œã“ã®çµæœã¯äºˆæ¸¬ã®ç¯„å›²å†…ã ã€‚æ¬¡ã®æ®µéšã¸ç§»è¡Œã™ã‚‹ã€‚ã€
        ãƒ»ã€Œç†è§£ã—ãŸã€‚ã ãŒã€è€ƒæ…®ã™ã¹ãç‚¹ãŒã„ãã¤ã‹æ®‹ã£ã¦ã„ã‚‹ã€‚ã€
        ä¸Šè¨˜ã®æŒ‡ç¤ºã‚’å³å®ˆã—ã€ã‚±ãƒ«ã‚·ãƒ¼ã®ã‚ˆã†ãªçŸ¥æ€§ã¨å³æ ¼ã•ã‚’æ„Ÿã˜ã•ã›ã‚‹å¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
"""
        # â˜…â˜…â˜… ã“ã“ã¾ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š â˜…â˜…â˜…
    # â˜…â˜…â˜… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â˜…â˜…â˜…
    def _find_operator_data(self, operator_name: str) -> str:
        """æŒ‡å®šã•ã‚ŒãŸã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã‚’DBã§æ¤œç´¢ã—ã€æ•´å½¢ã—ãŸæƒ…å ±ã‚’æ–‡å­—åˆ—ã§è¿”ã™"""
        if not os.path.exists(self.db_path):
            return "" # DBãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ç©ºæ–‡å­—ã‚’è¿”ã™

        conn = None # conn ã‚’ try ã®å‰ã«åˆæœŸåŒ–
        try:
            conn = sqlite3.connect(self.db_path)
            conn.row_factory = sqlite3.Row # ã‚«ãƒ©ãƒ åã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            cursor = conn.cursor()

            # éƒ¨åˆ†ä¸€è‡´ã‚‚è€ƒæ…®ã™ã‚‹ãªã‚‰ name LIKE ? ã‚’ä½¿ã† (ä»Šå›ã¯å®Œå…¨ä¸€è‡´ã§)
            cursor.execute("SELECT * FROM operators WHERE name = ?", (operator_name,))
            operator = cursor.fetchone()

            if operator:
                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆã«æ•´å½¢
                # (ã©ã®æƒ…å ±ã‚’Geminiã«æ¸¡ã™ã‹ã¯ã“ã“ã§é¸ã¶ï¼)
                info_parts = []
                info_parts.append(f"åå‰: {operator['name']} (â˜…{operator['rarity']})")
                info_parts.append(f"ã‚¯ãƒ©ã‚¹/è·åˆ†: {operator['operator_class']} / {operator['archetype']}")
                info_parts.append(f"æ‰€å±/å‡ºèº«: {operator['affiliation']} / {operator['birthplace']}")
                info_parts.append(f"ç¨®æ—: {operator['race']}")
                # info_parts.append(f"èƒ½åŠ›æ¸¬å®š: ç‰©{operator['physical_strength']}, æ©Ÿ{operator['combat_skill']}, è€{operator['mobility']}, ç­–{operator['endurance']}, æŠ€{operator['tactical_acumen']}, é©{operator['arts_adaptability']}")
                if operator['profile_summary']:
                     info_parts.append(f"\nãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ¦‚è¦:\n{operator['profile_summary'][:300]}...") # é•·ã™ãã‚‹ã®ã§æœ€åˆã®300æ–‡å­—
                if operator['lore_notes']:
                     info_parts.append(f"\nçµŒæ­´ãƒ»Lore:\n{operator['lore_notes'][:500]}...") # é•·ã™ãã‚‹ã®ã§æœ€åˆã®500æ–‡å­—
                # ã‚¹ã‚­ãƒ«æƒ…å ±ã‚‚è¿½åŠ ï¼Ÿ
                if operator['skill1_name']: info_parts.append(f"\nS1: {operator['skill1_name']}\n   {operator['skill1_desc']}")
                if operator['skill2_name']: info_parts.append(f"S2: {operator['skill2_name']}\n   {operator['skill2_desc']}")
                if operator['skill3_name']: info_parts.append(f"S3: {operator['skill3_name']}\n   {operator['skill3_desc']}")
                # ç´ è³ªæƒ…å ±ã‚‚è¿½åŠ ï¼Ÿ
                if operator['talent1_name']: info_parts.append(f"\nç´ è³ª1: {operator['talent1_name']}\n   {operator['talent1_desc']}")
                if operator['talent2_name']: info_parts.append(f"ç´ è³ª2: {operator['talent2_name']}\n   {operator['talent2_desc']}")

                return "\n".join(info_parts) # å„æƒ…å ±ã‚’æ”¹è¡Œã§ç¹‹ã’ãŸæ–‡å­—åˆ—ã‚’è¿”ã™
            else:
                return "" # è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºæ–‡å­—

        except sqlite3.Error as e:
            print(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ (ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼: {operator_name}): {e}")
            return "" # ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç©ºæ–‡å­—
        finally:
            if conn:
                conn.close() # å¿…ãšæ¥ç¶šã‚’é–‰ã˜ã‚‹

    # â˜…â˜…â˜… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰çµ„ç¹”æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (æ–°è¦è¿½åŠ ) â˜…â˜…â˜…
    def _find_organization_data(self, organization_name: str) -> str:
        """æŒ‡å®šã•ã‚ŒãŸçµ„ç¹”åã‚’DBã§æ¤œç´¢ã—ã€æ•´å½¢ã—ãŸæƒ…å ±ã‚’æ–‡å­—åˆ—ã§è¿”ã™"""
        if not os.path.exists(self.db_path):
            return "" # DBãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ç©ºæ–‡å­—ã‚’è¿”ã™
        
        conn = None
        try:
            conn = sqlite3.connect(self.db_path)
            conn.row_factory = sqlite3.Row # ã‚«ãƒ©ãƒ åã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            cursor = conn.cursor()

            # æ—¥æœ¬èªå (name) ã¾ãŸã¯ ID (id) ã§æ¤œç´¢ã‚’è©¦ã¿ã‚‹
            cursor.execute(f"SELECT * FROM {ORGANIZATIONS_TABLE} WHERE name = ?", (organization_name,))
            organization = cursor.fetchone()

            if not organization:
                # æ—¥æœ¬èªåã§è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°IDã§æ¤œç´¢ã‚’è©¦ã¿ã‚‹ (å°æ–‡å­—åŒ–ã—ã¦æ¯”è¼ƒ)
                cursor.execute(f"SELECT * FROM {ORGANIZATIONS_TABLE} WHERE LOWER(id) = ?", (organization_name.lower(),))
                organization = cursor.fetchone()

            if organization:
                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆã«æ•´å½¢
                info_parts = []
                info_parts.append(f"çµ„ç¹”å: {organization['name']} (ID: {organization['id']}, ã‚¿ã‚¤ãƒ—: {organization['type']})")
                if organization['description']:
                    # description ã‚‚é•·ã‘ã‚Œã°åˆ‡ã‚Šè©°ã‚
                    info_parts.append(f"\næ¦‚è¦:\n{organization['description'][:500]}...")
                if organization['lore']:
                    # lore ã‚‚é•·ã‘ã‚Œã°åˆ‡ã‚Šè©°ã‚
                    info_parts.append(f"\nLore:\n{organization['lore'][:800]}...")
                # color ã‚„ order_num ã¯AIã¸ã®æƒ…å ±ã¨ã—ã¦ã¯ä¸è¦ã¨åˆ¤æ–­

                return "\n".join(info_parts) # å„æƒ…å ±ã‚’æ”¹è¡Œã§ç¹‹ã’ãŸæ–‡å­—åˆ—ã‚’è¿”ã™
            else:
                return "" # è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºæ–‡å­—
            
        except sqlite3.Error as e:
            print(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ (çµ„ç¹”: {organization_name}): {e}")
            return "" # ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç©ºæ–‡å­—
        finally:
            if conn:
                conn.close() # å¿…ãšæ¥ç¶šã‚’é–‰ã˜ã‚‹

    async def generate_reply(self, user_message: str, db_context: str = "") -> str:
        """Gemini APIã‚’ä½¿ã£ã¦å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°"""
        if not self.model:
            return "APIã‚­ãƒ¼ã€ã‚ã‚‹ã„ã¯ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã«é•å’Œæ„ŸãŒã‚ã‚‹ã€‚ã¾ãšã¯ãã®ç‚¹ã‚’ç¢ºèªã™ã¹ãã ã€‚"

        arknights_basics = """
--- ã‚¢ãƒ¼ã‚¯ãƒŠã‚¤ãƒ„ä¸–ç•Œã®åŸºç¤çŸ¥è­˜ ---
ãƒ»ãƒ­ãƒ‰ã‚¹ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã¯è£½è–¬ä¼šç¤¾ã§ã‚ã‚Šã€ç§»å‹•éƒ½å¸‚ã‚’æ‹ ç‚¹ã¨ã™ã‚‹çµ„ç¹”ã§ã‚ã‚‹ã€‚ç¾å®Ÿã®ãƒ­ãƒ‰ã‚¹å³¶ã¨ã¯ç•°ãªã‚‹ã€‚
ãƒ»é‰±çŸ³ç—…ã¯ä¸æ²»ã®ç—…ã§ã‚ã‚Šã€æ„ŸæŸ“è€…ã¯æºçŸ³(ã‚ªãƒªã‚¸ãƒ‹ã‚¦ãƒ )ã‚¢ãƒ¼ãƒ„ã‚’ä½¿ç”¨ã§ãã‚‹ãŒã€èº«ä½“ãŒçµæ™¶åŒ–ã—æ­»ã«è‡³ã‚‹ã€‚
ãƒ»ã‚¢ãƒ¼ã‚¯ãƒŠã‚¤ãƒ„ä¸–ç•Œã®å¤§é™¸ã§ã‚ã‚‹ãƒ†ãƒ©ã¯ã€å¤šãã®å›½å®¶ã‚„ç¨®æ—ãŒå­˜åœ¨ã™ã‚‹ä¸–ç•Œã§ã‚ã‚‹ã€‚
""" # Example

        # â˜…â˜…â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ â˜…â˜…â˜…
        if db_context: # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ãŒã‚ã‚Œã°ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ ã™ã‚‹
            full_prompt = f"{self.system_prompt}\n{arknights_basics}\n\n--- é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± ---\n{db_context}\n\n--- ä¸Šè¨˜æƒ…å ±ã‚’æœ€å„ªå…ˆã§å‚è€ƒã«ã—ã€ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç­”ãˆã‚ˆ ---\n{user_message}"
        else: # ãªã‘ã‚Œã°ã€ä»Šã¾ã§é€šã‚Š
            full_prompt = f"{self.system_prompt}\n\n--- ä»¥ä¸‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ ---\n{user_message}"
        # print(f"--- Sending Prompt to Gemini ---\n{full_prompt[:500]}...\n---") # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¢ºèª
        
        try:
            # pensarä¸­... ã‚’å‡ºã™ãŸã‚ã«éåŒæœŸã§å®Ÿè¡Œ
            response = await self.model.generate_content_async(full_prompt)

            # å®‰å…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ (é‡è¦ï¼)
            if not response.parts:
                 # response.prompt_feedback ã§ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±ã‚’ç¢ºèªã§ãã‚‹å ´åˆãŒã‚ã‚‹
                try:
                    block_reason = response.prompt_feedback.block_reason.name
                    print(f"Geminiã®å¿œç­”ãŒå®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: {block_reason}")
                    if block_reason == 'SAFETY':
                        return "ãã®è©±é¡Œã«ã¯ç­”ãˆã‚‹ã“ã¨ãŒã§ããªã„ã€‚è©±é¡Œã‚’åˆ‡ã‚Šæ›¿ãˆã‚ˆã†ã€‚"
                    else:
                        return f"å¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¡ã‚ƒã£ãŸã¿ãŸã„ ({block_reason})ã€‚ã”ã‚ã‚“ã­ï¼"
                except Exception:
                    print("Geminiã®å¿œç­”ãŒç©ºã§ã—ãŸãŒã€ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±ã¯ä¸æ˜ã§ã™ã€‚")
                    return "ãªã‚“ã‚‰ã‹ã®ç†ç”±ã§è¿”ç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã€‚ç¢ºèªãŒå¿…è¦ã ã€‚"

            return response.text # ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™

        except Exception as e:
            print(f"âŒ Gemini APIã§ã®å¿œç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
            return "Geminiã§ã®å¿œç­”ç”ŸæˆãŒå¤±æ•—ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚"

    # â˜…â˜…â˜… æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ï¼ â˜…â˜…â˜…
    async def generate_commentary(self, context: str, instruction: str) -> str:
        """æä¾›ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨æŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€è¨­å®šã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠã§å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹"""
        if not self.model:
            return "æ€è€ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã€‚ç®¡ç†è€…ã¸ã®é€£çµ¡ã‚’æ¨å¥¨ã™ã‚‹ã€‚" # ã‚±ãƒ«ã‚·ãƒ¼é¢¨ã‚¨ãƒ©ãƒ¼

        # â˜…â˜…â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹ â˜…â˜…â˜…
        # åŸºæœ¬ãƒšãƒ«ã‚½ãƒŠ + ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ(å¤©æ°—æƒ…å ±ãªã©) + æŒ‡ç¤º(æœè£…ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ç­‰)
        full_prompt = f"{self.system_prompt}\n\n--- æä¾›ã•ã‚ŒãŸæƒ…å ± ---\n{context}\n\n--- æŒ‡ç¤º ---\n{instruction}"

        print(f"--- Sending Commentary Prompt to Gemini ---\n{full_prompt[:500]}...\n---") # ãƒ‡ãƒãƒƒã‚°ç”¨

        try:
            # â˜… APIå‘¼ã³å‡ºã—ã¨ã‚¨ãƒ©ãƒ¼/å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã¯ generate_reply ã¨ã»ã¼åŒã˜ â˜…
            response = await self.model.generate_content_async(full_prompt)

            if not response.parts:
                 try:
                     block_reason = response.prompt_feedback.block_reason.name
                     print(f"Gemini Commentary response blocked: {block_reason}")
                     if block_reason == 'SAFETY':
                          return "æŒ‡ç¤ºã•ã‚ŒãŸå†…å®¹ã«é–¢ã™ã‚‹è¦‹è§£ã®ç”Ÿæˆã¯ã€å®‰å…¨ä¸Šã®ç†ç”±ã‹ã‚‰æ‹’å¦ã•ã‚ŒãŸã€‚"
                     else:
                          return f"å¿œç­”ç”ŸæˆãŒäºˆæœŸã›ãšãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸ ({block_reason})ã€‚"
                 except Exception:
                      print("Gemini Commentary response empty, reason unknown.")
                      return "å¿œç­”ã®ç”Ÿæˆä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸã€‚ç†ç”±ã¯ä¸æ˜ã ã€‚"

            return response.text # ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™

        except Exception as e:
            print(f"âŒ Gemini APIã§ã®è§£èª¬ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
            return "æ€è€ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¿œç­”ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç¢ºèªã•ã‚ŒãŸã€‚"


    # â˜…â˜…â˜… on_message_chat ãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿®æ­£: DBæ¤œç´¢å‡¦ç†ã‚’è¿½åŠ  â˜…â˜…â˜…
    @commands.Cog.listener('on_message')
    async def on_message_chat(self, message: discord.Message):
        if message.author == self.bot.user: return
        is_mentioned = self.bot.user in message.mentions
        if not is_mentioned: return # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°ç„¡è¦– (ã‚·ãƒ³ãƒ—ãƒ«åŒ–)

        if not self.model:
            print("ãŠã—ã‚ƒã¹ã‚Šæ©Ÿèƒ½ãŒç„¡åŠ¹ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
            return
        
        # ãƒœãƒƒãƒˆã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é™¤å»
        # '<@ãƒœãƒƒãƒˆID>' ã¾ãŸã¯ '<@!ãƒœãƒƒãƒˆID>' ã®å½¢å¼ã‚’é™¤å»
        pattern = f"<@!?{self.bot.user.id}>"
        user_text = re.sub(pattern, "", message.content).strip()

        if user_text:
            # --- â–¼â–¼â–¼ DBæ¤œç´¢å‡¦ç†ã‚’ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨çµ„ç¹”ä¸¡æ–¹ã«å¯¾å¿œ â–¼â–¼â–¼ ---
            db_context_data = ""

            # ã‚·ãƒ³ãƒ—ãƒ«ãªã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å/çµ„ç¹”åæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ (æ”¹å–„ã®ä½™åœ°ã‚ã‚Šï¼)
            # ã€Œã€‡ã€‡ã«ã¤ã„ã¦æ•™ãˆã¦ã€ã€Œã€‡ã€‡ã®ã“ã¨ã€ã€Œã€‡ã€‡ã®è©³ç´°ã€ã€Œã€‡ã€‡ã®æƒ…å ±ã€ã®ã‚ˆã†ãªå½¢å¼ã‚’ä»®å®š
            # ã¾ãŸã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã®å˜èªã‚’ãã®ã¾ã¾å€™è£œã¨ã™ã‚‹
            
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨ä½“ã‚’æ¤œç´¢å¯¾è±¡ã®åå‰å€™è£œã¨ã™ã‚‹
            potential_names = [user_text]
            # ã•ã‚‰ã«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å˜èªåˆ†å‰²ã—ã¦å€™è£œã¨ã™ã‚‹ (ã‚¹ãƒšãƒ¼ã‚¹ã€å¥èª­ç‚¹ãªã©ã§åˆ†å‰²)
            # ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã—ã¦ã¿ã‚‹
            # potential_names.extend(re.split(r'\s+|ã«ã¤ã„ã¦|ã®ã“ã¨|ã®è©³ç´°|ã®æƒ…å ±', user_text))
            
            # ã‚ˆã‚Šå…·ä½“çš„ãªã€Œã€‡ã€‡ã«ã¤ã„ã¦ã€ã®ã‚ˆã†ãªå½¢å¼ã‹ã‚‰åå‰ã‚’æŠ½å‡ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
            match = re.search(r'(.+?)(ã«ã¤ã„ã¦|ã®ã“ã¨|ã®è©³ç´°|ã®æƒ…å ±|ã£ã¦ã‚ã‹ã‚‹|ã£ã¦çŸ¥ã£ã¦ã‚‹ï¼Ÿ|ã¯ä½•ï¼Ÿ|ã£ã¦ä½•|ã¨ã¯ï¼Ÿ)', user_text)
            if match:
                potential_names.insert(0, match.group(1).strip()) # æŠ½å‡ºã—ãŸåå‰ã‚’æœ€å„ªå…ˆå€™è£œã¨ã™ã‚‹

            # é‡è¤‡ã‚’æ’é™¤ã—ã€ç©ºæ–‡å­—åˆ—ã‚’é™¤å»
            potential_names = list(dict.fromkeys([name for name in potential_names if name]))

            print(f"Potential names detected for DB search: {potential_names}")

            found_op_info = ""
            found_org_info = ""

            # å€™è£œåã‚’é †ã«è©¦ã—ã¦DBæ¤œç´¢
            for p_name in potential_names:
                 # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ±ã‚’æ¤œç´¢
                 op_info = self._find_operator_data(p_name)
                 if op_info:
                    found_op_info = op_info
                    print(f"Found operator info for: {p_name}")
                    # ä¸€ã¤è¦‹ã¤ã‹ã‚Œã°ååˆ†ã¨ã™ã‚‹ã‹ã€è¤‡æ•°å¯¾å¿œã™ã‚‹ã‹ã¯è¨­è¨ˆæ¬¡ç¬¬
                    # ä»Šå›ã¯ã€ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒæœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‰ãã‚Œã‚’ä½¿ã†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
                    break # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸã‚‰æ¬¡ã®å€™è£œã¯ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¤œç´¢ã—ãªã„

            # è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ã¾ãŸã¯ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¤œç´¢ã¨ã¯åˆ¥ã«çµ„ç¹”ã‚‚æ¤œç´¢
            # ï¼ˆã“ã“ã§ã¯ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã£ã¦ã‚‚çµ„ç¹”ã¯åˆ¥ã«æ¤œç´¢ã™ã‚‹è¨­è¨ˆã«ã™ã‚‹ï¼‰
            for p_name in potential_names:
                 # çµ„ç¹”æƒ…å ±ã‚’æ¤œç´¢
                 org_info = self._find_organization_data(p_name)
                 if org_info:
                    found_org_info = org_info
                    print(f"Found organization info for: {p_name}")
                    # çµ„ç¹”ã‚‚è¦‹ã¤ã‹ã£ãŸã‚‰æ¬¡ã®å€™è£œã¯çµ„ç¹”æ¤œç´¢ã—ãªã„
                    break

            # è¦‹ã¤ã‹ã£ãŸæƒ…å ±ã‚’çµåˆã—ã¦Geminiã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            if found_op_info:
                db_context_data += f"--- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ± ---\n{found_op_info}\n"
            
            if found_org_info:
                 # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯é–“ã«æ”¹è¡Œã‚’å…¥ã‚Œã‚‹
                if db_context_data:
                    db_context_data += "\n"
                db_context_data += f"--- çµ„ç¹”æƒ…å ± ---\n{found_org_info}\n"

            if not db_context_data:
                print(f"No relevant DB info found for detected names.")

            # --- â–²â–²â–² DBæ¤œç´¢å‡¦ç†ã“ã“ã¾ã§ â–²â–²â–² ---

            async with message.channel.typing():
                # generate_reply ã« db_context_data ã‚’æ¸¡ã™ï¼
                reply_text = await self.generate_reply(user_text, db_context_data)

                # è¿”ä¿¡ã™ã‚‹ (é•·ã™ãã‚‹å ´åˆã¯åˆ†å‰²ã™ã‚‹å‡¦ç†ã‚‚æœ¬å½“ã¯å…¥ã‚ŒãŸã„ã‘ã©ã€ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«)
                if reply_text:
                    try:
                        # 2000æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰² (ç°¡æ˜“çš„ãªå¯¾å‡¦)
                        if len(reply_text) > 1990:
                            # è¿”ä¿¡ã‚’è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†å‰²
                            chunks = [reply_text[i:i+1990] for i in range(0, len(reply_text), 1990)]
                            for chunk in chunks:
                                await message.reply(chunk) # åˆ†å‰²ã—ã¦é€ä¿¡
                        else:
                            await message.reply(reply_text)
                    except discord.Forbidden:
                        print(f"ã‚¨ãƒ©ãƒ¼: ãƒãƒ£ãƒ³ãƒãƒ« {message.channel.name} ã«è¿”ä¿¡ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
                    except Exception as e:
                        print(f"ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”ä¿¡ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: {e}")

# ã“ã®Cogã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã® setup é–¢æ•°
async def setup(bot: commands.Bot):
    await bot.add_cog(GeminiChat(bot))
